<%inherit file="base.html" />
<%namespace name='static' file='static_content.html'/>

<%block name="title">Textbooks</%block>
<%block name="bodyclass">is-signedin course textbooks</%block>

<%block name="header_extras">
  <script type="text/template" id="new-textbook-tpl">
    <%static:include path="js/textbook.underscore" />
  </script>
  <script type="text/template" id="new-chapter-tpl">
    <%static:include path="js/chapter.underscore" />
  </script>
  <script type="text/template" id="upload-dialog-tpl">
    <%static:include path="js/upload-dialog.underscore" />
  </script>
</%block>

<%block name="jsextra">
<script type="text/javascript" src="${static.url('js/vendor/jquery.fineuploader-3.5.0/jquery.fineuploader-3.5.0.min.js')}"></script>
<script type="text/javascript">
window.UPLOAD_ASSET_CALLBACK_URL = "${upload_asset_callback_url}"

CMS.Models.Textbook = Backbone.Model.extend({
    defaults: {
        name: ""
    },
    initialize: function() {
        this.chapters = new CMS.Collections.ChapterSet;
        this.chapters.add([{}]);
    }
})
CMS.Models.Chapter = Backbone.Model.extend({
    defaults: function() {
        return {
            name: "",
            asset_path: "",
            order: this.collection ? this.collection.nextOrder() : 1
        }
    }
})
CMS.Collections.ChapterSet = Backbone.Collection.extend({
    model: CMS.Models.Chapter,
    comparator: "order",
    nextOrder: function() {
        if(!this.length) return 1;
        return this.last().get('order') + 1;
    }
})
CMS.Views.TextbookEdit = Backbone.View.extend({
    initialize: function() {
        this.template = _.template($("#new-textbook-tpl").text());
        this.listenTo(this.model.chapters, "add", this.addOne);
        this.listenTo(this.model.chapters, "reset", this.addAll);
        this.listenTo(this.model.chapters, "all", this.render);
    },
    render: function() {
        this.$el.html(this.template({
            name: this.model.escape('name'),
        }));
        this.addAll();
        return this;
    },
    events: {
        "submit": "save",
        "click .action-cancel": "remove",
        "click .action-add-chapter": "createChapter"
    },
    addOne: function(chapter) {
        var view = new CMS.Views.ChapterEdit({model: chapter});
        this.$("ol.chapters").append(view.render().el)
        return this;
    },
    addAll: function() {
        this.model.chapters.each(this.addOne, this);
    },
    createChapter: function(e) {
        if(e && e.preventDefault) { e.preventDefault(); }
        this.model.chapters.add([{}])
    },
    save: function(e) {
        if(e && e.preventDefault) { e.preventDefault(); }
        alert("save is currently unimplemented")
    }

})
CMS.Views.ChapterEdit = Backbone.View.extend({
    initialize: function() {
        this.template = _.template($("#new-chapter-tpl").text());
        this.listenTo(this.model, "change", this.render)
    },
    render: function() {
        this.$el.html(this.template({
            name: this.model.escape('name'),
            asset_path: this.model.escape('asset_path'),
            order: this.model.get('order')
        }));
        return this;
    },
    events: {
        "click .action-close": "removeChapter",
        "click .action-uploadasset": "openUploadDialog",
        "submit": "uploadAsset"
    },
    removeChapter: function(e) {
        if(e && e.preventDefault) { e.preventDefault(); }
        this.model.collection.remove(this.model);
        return this.remove();
    },
    openUploadDialog: function(e) {
        if(e && e.preventDefault) { e.preventDefault(); }
        var msg = new CMS.Models.SystemFeedback({
            intent: "upload",
            title: _.str.sprintf(gettext("Upload a new asset to %s"),
                section.escape('name')),
            message: "[asset upload requirements]"
        })
        var view = new CMS.Views.UploadDialog({model: msg, chapter: this.model})
        this.$el.append(view.render().el)
    }
})
CMS.Views.UploadDialog = Backbone.View.extend({
    initialize: function() {
        this.template = _.template($("#upload-dialog-tpl").text());
        this.listenTo(this.model, "change", this.render);
    },
    render: function() {
        // Browsers have a lot of security around <input type="file"> DOM elements,
        // and they forbid Javascript from setting the file path of such an element.
        // This means that, instead of saving the info in the model object and
        // passing it to the template to be re-rendered, we have to save the element
        // and swap it in to the newly-rendered template, so that we don't lose the
        // information. It's a hack, but it's necessary. :(
        var oldInput = this.$("input[type=file]")
        this.$el.html(this.template({
            title: this.model.escape('title'),
            message: this.model.escape('message'),
            uploadFile: this.model.get('uploadFile'),
            uploading: this.model.get('uploading') || false,
            uploadPercentage: this.model.get('uploadPercentage') || 0,
        }))
        // only create the uploader if we haven't already started uploading
        if(!this.model.get('uploading')) {
            this.createUploader();
        }
        if(oldInput.length) {
            this.$("input[type=file]").replaceWith(oldInput);
        }
        return this;
    },
    createUploader: function() {
        this.uploader = this.$el.fineUploader({
            debug: true,
            uploaderType: "basic",
            request: {
                endpoint: UPLOAD_ASSET_CALLBACK_URL,
                inputName: "file",
                uuidName: "uuid",
                totalFileSizeName: "size",
                customHeaders: {
                    'X-CSRFToken': $.cookie('csrftoken')
                }
            },
            button: this.$(".action-select"),
            multiple: false,
            autoUpload: false,
            validation: {
                // allowedExtensions: ['pdf'],
                sizeLimit: 999999999
            }
        });
        this.uploader
            .on('submit', _.bind(this.onSubmit, this))
            .on('error', _.bind(this.onError, this))
            .on('progress', _.bind(this.onProgress, this))
            .on('complete', _.bind(this.onComplete, this));
        this.$el.fineUploader('addFiles', this.model.get('uploadFile'))
        return this.uploader;
    },
    events: {
        "click .action-cancel": "removeSelf",
        "click .action-upload": "upload"
    },
    removeSelf: function(e) {
        if(e && e.preventDefault) { e.preventDefault(); }
        this.remove();
    },
    upload: function(e) {
        if(e && e.preventDefault) { e.preventDefault(); }
        this.$el.fineUploader('uploadStoredFiles');
        this.model.set('uploading', true);
    },
    onSubmit: function(event, id, name) {
        this.model.set('uploadFile', this.$el.fineUploader('getFile', id));
    },
    onError: function(event, id, name, errorReason, xhr) {
        debugger;
    },
    onProgress: function(event, id, name, uploadedBytes, totalBytes) {
        console.log('completed '+uploadedBytes+' of '+totalBytes);
        this.model.set("uploadPercentage", uploadedBytes/totalBytes*100);
    },
    onComplete: function(event, id, name, response) {
        this.model.set('uploading', false);
        var chapter = this.options.chapter;
        if(chapter) {
            if(!chapter.get("name")) {
                chapter.set("name", response.displayname);
            }
            chapter.set("asset_path", response.url);
        }
        this.remove();
    }
})
var section = new CMS.Models.Section({
    id: "${course.id}",
    name: "${course.display_name_with_default | h}"
});
$(function() {
    $(".new-button").click(function() {
        var textbook = new CMS.Models.Textbook();
        var view = new CMS.Views.TextbookEdit({model: textbook})
        $(".inner-wrapper").append(view.render().el);
    })
})
</script>
</%block>

<%block name="content">
  <div class="wrapper-mast wrapper">
    <header class="mast has-actions has-subtitle">
      <h1 class="page-header">
        <small class="subtitle">Course Content</small>
        <span class="sr">&gt; </span>Textbooks
      </h1>

      <nav class="nav-actions">
        <h3 class="sr">Page Actions</h3>
        <ul>
          <li class="nav-item">
            <a href="#" class="button upload-button new-button"><i class="icon-cloud-upload "></i> New Textbook</a>
          </li>
        </ul>
      </nav>
    </header>
  </div>

  <div class="wrapper-content wrapper">
    <section class="content">
    <div class="inner-wrapper">
        <div class="introduction has-links">
          <p class="copy">Textbooks are happy. Textbooks are cool. This is the filler text explaining why you should use a feature as happy and as cool as textbooks. If you use textbooks, you will make friends and influence people. You will lose weight and people will compliment you on your appearance. Children around the world will sing praises to your name, and celebrities will recongize you as a totally hip and groovy person. If you don't use textbooks, your life will be forever incomplete, and you will die alone and unloved. Make the right choice. Upload your first textbook now.</p>

          <nav class="nav-introduction-supplementary">
            <ul>
              <li class="nav-item"><a href="#" rel="modal" title="This link will open in a modal window"><i class="icon-question-sign"></i> Need help adding a textbook?</a></li>
            </ul>
          </nav>
        </div>
    </div>
    </section>
  </div>
</%block>
